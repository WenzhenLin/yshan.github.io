var CN=108;var SUITES=["h","s","d","c","j","J"];var SUITES_MSG={"-1":"无主",h:"红桃",s:"黑桃",d:"方块",c:"梅花",j:"小鬼",J:"大鬼"};var LOC_MSG=["南","东","北","西"];var POINTS=[2,3,4,5,6,7,8,9,10,"J","Q","K","A","O"];function val(a){if(a>53){a=a-54}if(a==53){return["J","O"]}if(a==52){return["j","O"]}var c=a%13;var b=(a-c)/13;return[SUITES[b],POINTS[c]]}function str(a){var b=val(a);return b[0]+b[1]}function strs(c){var a=[];for(var b=0;b<c.length;++b){a.push(str(c[b]))}return a}var STATUS={NOT_STARTED:0,DEAL:1,KOUDI:2,PLAY:3,COMPLETE:3};function Turn(){this.leader=-1;this.cards=[];this.suite=-1;this.groupsCount;this.lastScore;this.addCards=function(a){this.cards.push(a)}}function Director(){var v=new Array(CN);var q;var d;var n;var o;var k;var s;var b;var l;var t;var m;var f;var y;var p;var j;var c;var x;var r=function(){for(var z=0;z<CN;++z){v[z]=-1}n=0;k=0;s=[0,0];o=0;x=true};this.getAllCards=function(){return v.slice(0)};this.getMasterSuite=function(){return b};this.getCurrentPoint=function(){return POINTS[k]};this.getPoints=function(){return[POINTS[s[0]],POINTS[s[1]]]};this.getCurrentScore=function(){return l};this.getCurrentPlayer=function(){return p};this.getLastMasterOwner=function(){return m};this.getCurrentMasterCount=function(){return t};this.setPlayers=function(A){d=A;for(var z=0;z<d.length;++z){d[z].setDirector(this)}};this.getStatus=function(){return o};this.getBoss=function(){return n};this.isLeader=function(){return j%4==0};this.isFirstGame=function(){return x};this.getCurrentTurn=function(){if(c.length>0){return c[c.length-1]}return null};this.getPreviousTurn=function(){if(c.length>1){return c[c.length-2]}return null};this.makeCard=function(B,z){if(B=="j"){return 52}else{if(B=="J"){return 53}else{if(B=="X"){B=b}}}var A,C;for(A=0;A<4;++A){if(SUITES[A]==B){for(C=0;C<13;++C){if(POINTS[C]==z){return A*13+C}}}}return -1};var g=function(){q=new Array(CN);for(var A=0;A<CN;++A){var B=A%54;var z=u(A);if(B==53){B=10000}else{if(B==52){B=9999}else{if(z[1]>0){B=1000+z[2]}else{if(B%13>k){--B}if(z[2]>0){B+=100}}}}q[A]=B}};this.newGame=function(){o=STATUS.DEAL;b=-1;t=0;k=s[n%2];m=-1;f=new Array(CN);y=n;l=0;c=[];for(var B=0;B<CN;++B){v[B]=-1}for(var B=0;B<4;++B){d[B].newGame()}for(var B=0;B<CN;++B){f[B]=B}for(var B=0;B<CN;++B){var z=Math.floor((Math.random()*CN));if(B!=z){var A=f[B];f[B]=f[z];f[z]=A}}};this.endGame=function(){x=false;var z=c[c.length-1];var C=this.getTurnWinner(z);if(C%2!=n%2){var D=this.getDiCards();var A=a(D);if(A>0){var E=2;var B=this.groupCards(z.cards[0]);switch(B[0].length){case 2:E=4;break;case 4:E=8;break;case 6:E=12;break;case 8:E=16;break;default:E=2;break}l+=(A*E)}}if(l<80){if(s[n%2]==12){return n}var F=Math.floor((80-l)/20+1);s[n%2]+=F;n=(n+2)%4}else{var F=Math.floor((l-80)/20+1);n=(n+1)%4;if(s[n%2]!=0){s[n%2]+=F}}if(s[n%2]>12){s[n%2]=12}return -1};this.deal=function(){if(o==STATUS.DEAL&&f.length>8){var z=f.pop();v[z]=y;d[y].deal(z);console.log("deal card:"+z+" to:"+y);if(++y>=4){y=0}return true}return false};this.dealdi=function(){if(o==STATUS.DEAL&&f.length==8){g();for(var A=0;A<f.length;++A){var z=f[A];v[z]=n;d[n].deal(z)}for(var A=0;A<4;++A){d[A].deal(-1)}o=STATUS.KOUDI;return true}return false};var i=function(A,B){if(o!=STATUS.DEAL){return false}var D=POINTS[k];var C=0;for(var z=0;z<CN;++z){if(v[z]==A){var E=val(z);if(E[0]==B&&(E[1]==D||E[1]=="O")){++C}}}if(B=="j"||B=="J"){if(C<2){return false}if(b=="j"&&B!="J"){return false}if(b=="J"){return false}}else{if(C<=t){return false}}if(A==m&&B!=b){return false}return true};this.getMasterSuites=function(B){var z=[];for(var A=0;A<SUITES.length;++A){var C=SUITES[A];if(i(B,C)){z.push(C)}}return z};this.makeMaster=function(z,A){if(!i(z,A)){return false}if(x){n=z}b=A;++t;if(t>2){t=2}m=z;return true};this.getDiCards=function(){var z=[];for(var A=0;A<CN;++A){if(v[A]==10){z.push(A)}}return z};this.koudi=function(B,C){if(o!=STATUS.KOUDI){return false}if(B!=n){return false}if(C.length!=8){return false}for(var A=0;A<C.length;++A){if(v[C[A]]!=B){return false}}for(var A=0;A<C.length;++A){var z=C[A];v[z]=10}o=STATUS.PLAY;p=n;j=0;return true};var u=function(E){var B=val(E);var C=0,z=0,A=0;if(B[1]=="O"){C=1;A=1}else{if(B[1]==POINTS[k]){z=1;A=1}if(B[0]==b){++A}}var D=0;if(B[1]=="K"||B[1]==10){D=10}else{if(B[1]==5){D=5}}return[C,z,A,B[0],B[1],D]};var h=function(A,z){return(q[A]==q[z])?(A%54-z%54):(q[A]-q[z])};this.compareCard=function(A,z){return q[A]-q[z]};var e=function(z){z.sort(function(B,A){if(A.length==B.length){return h(B[0],A[0])}return A.length-B.length})};this.descCard=function(z){return u(z)};this.groupCards=function(z){z.sort(h);var L=[];var D=0;var B=-1;var J;while(D<z.length){var K=D;var A=q[z[K]];var G=K;var I=A;var H=z[K]%54;var F;while(++D<z.length){var C=q[z[D]];var E=z[D]%54;F=(D-K)+1;if(((F%2==0)&&(C==I&&E==H))||((F%2==1)&&(C==I+1))){I=C;H=E;G=D;continue}break}F=(G-K)+1;if(F>1&&F%2!=0){--G;--D}L.push(z.slice(K,G+1))}e(L);return L};this.groupCardsCount=function(D){var A={};var z=this.groupCards(D);for(var B=0;B<z.length;++B){var C=z[B];if(A[C.length]){++(A[C.length])}else{A[C.length]=1}}return A};this.sortCards=function(z){return z.sort(h)};this.getPlayerCards=function(C,D){var E=[];var A=(D=="X");for(var B=0;B<CN;++B){var F=v[B];if(F==C){var z=u(B);if(A&&z[2]>0){E.push(B)}else{if(!A&&z[2]==0&&z[3]==D){E.push(B)}}}}return E};this.getPlayerGroupCards=function(z,A){return this.groupCards(this.getPlayerCards(z,A))};this.matchGroups=function(B,A){for(var C=0;C<B.length;++C){var z=B[C].length;if(z>1){if(A.length==0||A[0].length<z){return false}else{if(A[0].length>z){A[0].splice(0,z);e(A)}else{if(A[0].length==z){A.splice(0,1)}}}}}return true};var w=function(E){var z=u(E[0]);var D=(z[2]>0)?"X":z[3];for(var B=1;B<E.length;++B){var A=u(E[B]);var C=(A[2]>0)?"X":A[3];if(C!=D){return false}}return true};this.getTurnWinner=function(L){var E=0;var F=[];for(var D=0;D<L.cards.length;++D){F.push(this.groupCards(L.cards[D]))}var z=F[0][0].length;var H=-1;for(var D=0;D<F[0].length;++D){if(F[0][D].length>=z){var G=F[0][D][F[0][D].length-1];if(G>H){H=G}}}var J=u(H);for(var D=1;D<L.cards.length;++D){var A=false;var K=H;for(var C=0;C<F[D].length;++C){if(F[D][C].length>=z){var B=F[D][C][F[D][C].length-1];if(h(B,K)>0){A=true;K=B}}}var G=F[D][0][0];if(A&&w(L.cards[D])&&this.matchGroups(F[0],F[D])){var I=u(G);if(I[2]==0&&I[3]!=J[3]){continue}E=D;H=K}}return(L.leader+E)%4};var a=function(B){var C=0;for(var A=0;A<B.length;++A){var z=val(B[A])[1];if(z==5){C+=5}else{if(z==10||z=="K"){C+=10}}}return C};this.getTurnScore=function(A){var C=0;for(var z=0;z<A.cards.length;++z){var B=A.cards[z];C+=a(B)}return C};this.play=function(M,z){if(!this.isLegalPlay(M,z)){return false}var L=(j%4==0);if(L){var B=this.groupCards(z);var N=u(z[0]);var J=(N[2]>0)?"X":N[3];if(B.length>1){var P=false;var K=-1;for(var A=0;A<4&&!P;++A){if(A!=M){var I=this.getPlayerGroupCards(A,J);for(var E=0;E<B.length&&!P;++E){var H=B[E];var G=q[H[0]];for(var D=0;D<I.length&&!P;++D){if(H.length<=I[D].length&&q[I[D][0]]>G){P=true;K=E}}}}}if(P){z.splice(0,z.length);var H=B[K];for(var E=0;E<H.length;++E){z.push(H[E])}}}var O=new Turn();O.suite=J;O.leader=p;O.lastScore=l;O.groupsCount=this.groupCardsCount(z);c.push(O)}console.log("player:"+M+",out:"+strs(z));for(var E=0;E<z.length;++E){var C=z[E];v[C]=M+4}c[c.length-1].addCards(z);if(++j%4==0){var O=c[c.length-1];var F=this.getTurnWinner(O);if(F%2!=n%2){l+=this.getTurnScore(O)}p=F}else{++p;if(p>=4){p=0}}return true};this.isLegalPlay=function(L,z){if(o!=STATUS.PLAY){return false}if(L!=p){return false}if(z.length<1){return false}for(var F=0;F<z.length;++F){if(v[z[F]]!=L){return false}}var I=(j%4==0);if(I){var P=-1;var C=-1;for(var F=0;F<z.length;++F){var B=z[F];var M=u(B);if(P==-1){P=M[3];C=M[2]}else{if(C>0&&M[2]>0){continue}else{if(P!=M[3]){return false}}}}}else{var O=c[c.length-1];if(z.length!=O.cards[0].length){return false}var D=this.getPlayerCards(L,O.suite);if(D.length<=z.length){for(var F=0;F<D.length;++F){var H=D[F];var G=false;for(var E=0;E<z.length;++E){if(H==z[E]){G=true;break}}if(!G){return false}}}else{for(var F=0;F<z.length;++F){var H=z[F];var G=false;for(var E=0;E<D.length;++E){if(H==D[E]){G=true;break}}if(!G){return false}}var K=this.groupCardsCount(D);var J=this.groupCardsCount(z);for(var F in O.groupsCount){if(F>1){var A=O.groupsCount[F];var N=F;while(N>=2&&!K[N]){N=N-2}if(F!=N){A=Math.floor((A*F/N))}if(!K[N]){continue}if(!J[N]){return false}if(K[N]>=A){if(J[N]<A){return false}}else{if(J[N]!=K[N]){return false}}}}}}return true};this.isGameover=function(){for(var z=0;z<CN;++z){if(v[z]>=0&&v[z]<=3){return false}}return true};this.undoTurn=function(){if(c.length>0){var C=c.pop();for(var B=0;B<C.cards.length;++B){var z=(C.leader+B)%4;var D=C.cards[B];for(var A=0;A<D.length;++A){var E=D[A];v[E]=z;d[z].deal(E)}d[z].deal(-1);--j}p=C.leader;l=C.lastScore}};r()};